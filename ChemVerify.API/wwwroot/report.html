<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chemical Verification Report — ChemVerify</title>
    <style>
        /* ── Reset & Base ───────────────────────────────────── */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: #ffffff;
            color: #1a1a1a;
            font-family: 'Source Sans Pro', 'Inter', 'Segoe UI', system-ui, sans-serif;
            font-size: 15px;
            line-height: 1.7;
            max-width: 820px;
            margin: 0 auto;
            padding: 3rem 2.5rem;
        }

        /* ── Document Title ─────────────────────────────────── */
        .report-title {
            font-family: 'Georgia', 'Cambria', 'Times New Roman', serif;
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.3px;
            color: #111;
            border-bottom: 2px solid #111;
            padding-bottom: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .report-meta {
            font-size: 0.82rem;
            color: #666;
            margin-bottom: 2.5rem;
            line-height: 1.9;
        }

        .report-meta span { margin-right: 2rem; }

        /* ── Section Headers ────────────────────────────────── */
        .section-title {
            font-family: 'Georgia', 'Cambria', 'Times New Roman', serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e3a5f;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            border-bottom: 1px solid #d0d0d0;
            padding-bottom: 0.3rem;
            margin-top: 2.2rem;
            margin-bottom: 0.8rem;
        }

        /* ── Body Text ──────────────────────────────────────── */
        .verdict-text {
            font-size: 1rem;
            line-height: 1.8;
            color: #222;
            margin-bottom: 0.5rem;
        }

        .risk-line {
            font-size: 1rem;
            margin-bottom: 0.6rem;
        }

        .risk-value {
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .risk-label {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.3px;
        }

        .risk-label-Low { color: #15803d; }
        .risk-label-Medium { color: #b45309; }
        .risk-label-High { color: #dc2626; }
        .risk-label-Critical { color: #991b1b; }

        .risk-scale {
            font-size: 0.78rem;
            color: #777;
            line-height: 1.8;
            margin-top: 0.5rem;
        }

        /* ── Findings Lists ─────────────────────────────────── */
        .finding-category {
            font-size: 0.82rem;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 1rem;
            margin-bottom: 0.3rem;
        }

        .finding-list {
            list-style: disc;
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .finding-list li {
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }

        .finding-none {
            font-size: 0.9rem;
            color: #888;
            font-style: italic;
        }

        /* ── Attention Block ────────────────────────────────── */
        .attention-block {
            border-left: 3px solid #b45309;
            padding: 0.6rem 1rem;
            margin-top: 0.5rem;
            background: #fffbf5;
        }

        .attention-block li {
            font-size: 0.95rem;
            color: #92400e;
        }

        /* ── Claims Table ───────────────────────────────────── */
        .claims-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
            margin-top: 0.5rem;
        }

        .claims-table th {
            text-align: left;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.72rem;
            border-bottom: 2px solid #ccc;
            padding: 0.4rem 0.6rem;
        }

        .claims-table td {
            padding: 0.35rem 0.6rem;
            border-bottom: 1px solid #e8e8e8;
            vertical-align: top;
        }

        .claims-table code {
            font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
            font-size: 0.8rem;
            color: #333;
            background: none;
        }

        /* ── Questions ──────────────────────────────────────── */
        .questions-list {
            list-style: decimal;
            padding-left: 1.5rem;
        }

        .questions-list li {
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }

        /* ── Provenance ─────────────────────────────────────── */
        .provenance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.3rem 2rem;
            font-size: 0.82rem;
            margin-top: 0.5rem;
        }

        .prov-label {
            color: #888;
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .prov-value {
            font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
            font-size: 0.78rem;
            color: #333;
            word-break: break-all;
            margin-bottom: 0.5rem;
        }

        /* ── Analyzed Text ──────────────────────────────────── */
        .analyzed-text {
            font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
            font-size: 0.8rem;
            color: #555;
            line-height: 1.7;
            white-space: pre-wrap;
            word-break: break-word;
            padding: 0.8rem 0 0.8rem 1.5rem;
            margin-top: 0.5rem;
        }

        .evidence-highlight {
            background: #fff3cd;
            border-bottom: 2px solid #b45309;
            padding: 0 1px;
        }

        /* ── Footer ─────────────────────────────────────────── */
        .report-footer {
            margin-top: 3rem;
            padding-top: 0.8rem;
            border-top: 1px solid #ccc;
            font-size: 0.72rem;
            color: #aaa;
            text-align: center;
        }

        /* ── Procedure Map ──────────────────────────────────── */
        .procedure-map { margin-top: 0.5rem; }

        .step-row {
            display: flex;
            align-items: flex-start;
            gap: 0.6rem;
            padding: 0.4rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .step-index {
            font-weight: 600;
            font-size: 0.78rem;
            color: #1e3a5f;
            min-width: 3rem;
            flex-shrink: 0;
            padding-top: 0.1rem;
        }

        .step-body { flex: 1; }

        .step-snippet {
            font-size: 0.85rem;
            color: #444;
            line-height: 1.5;
        }

        .step-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.3rem;
        }

        .claim-badge {
            display: inline-block;
            font-size: 0.72rem;
            font-weight: 600;
            padding: 0.1rem 0.45rem;
            border-radius: 3px;
            background: #e8f0fe;
            color: #1a56db;
            border: 1px solid #bdd4f7;
        }

        .claim-badge-temp { background: #fef3c7; color: #92400e; border-color: #f59e0b; }
        .claim-badge-time { background: #dbeafe; color: #1e40af; border-color: #3b82f6; }
        .claim-badge-yield { background: #d1fae5; color: #065f46; border-color: #10b981; }
        .claim-badge-conc { background: #ede9fe; color: #5b21b6; border-color: #8b5cf6; }

        .cluster-summary {
            border-left: 3px solid #1e3a5f;
            padding: 0.6rem 1rem;
            margin-top: 0.5rem;
            margin-bottom: 0.8rem;
            background: #f8fafc;
        }

        .cluster-item {
            font-size: 0.9rem;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .cluster-label {
            font-weight: 700;
            color: #1e3a5f;
        }

        .issue-card {
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 0.8rem 1rem;
            margin-top: 0.5rem;
            background: #fffbf5;
        }

        .issue-title {
            font-weight: 700;
            font-size: 0.95rem;
            color: #92400e;
        }

        .issue-confidence {
            font-size: 0.82rem;
            color: #666;
            margin-top: 0.2rem;
        }

        .issue-why {
            list-style: disc;
            padding-left: 1.5rem;
            margin-top: 0.3rem;
        }

        .issue-why li {
            font-size: 0.85rem;
            color: #555;
            margin-bottom: 0.15rem;
        }

        /* ── Risk Drivers ────────────────────────────────────── */
        .risk-drivers {
            margin-top: 0.6rem;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 0.6rem 0.8rem;
            background: #f9fafb;
        }

        .risk-driver {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            font-size: 0.88rem;
            line-height: 1.7;
        }

        .risk-driver-delta {
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            min-width: 3.5rem;
            text-align: right;
        }

        .risk-driver-delta.positive { color: #dc2626; }
        .risk-driver-delta.negative { color: #15803d; }
        .risk-driver-delta.neutral { color: #6b7280; }

        .risk-driver-label { color: #333; }

        /* ── Loading / Error ────────────────────────────────── */
        .loading-state {
            text-align: center;
            padding: 4rem 0;
            color: #888;
            font-size: 0.95rem;
        }

        .error-state {
            text-align: center;
            padding: 4rem 0;
            color: #dc2626;
            font-size: 0.95rem;
        }

        /* ── Print ──────────────────────────────────────────── */
        @media print {
            body { padding: 1.5cm 2cm; font-size: 11pt; max-width: none; }
            .report-title { font-size: 16pt; }
            .section-title { font-size: 11pt; break-after: avoid; }
            .claims-table { font-size: 8pt; }
            .report-footer { font-size: 7pt; }
            .attention-block { background: none; border-left-color: #000; }
            .cluster-summary { background: none; border-left-color: #000; }
            .issue-card { background: none; }
        }
    </style>
</head>
<body>

<div id="loadingState" class="loading-state">Loading verification report…</div>
<div id="errorState" class="error-state" style="display:none;"></div>

<div id="reportContent" style="display:none;">

    <!-- Title Block -->
    <div class="report-title">Chemical Verification Report</div>
    <div style="font-size:0.82rem; font-style:italic; color:#888; margin-bottom:0.6rem;">Generated by ChemVerify — AI Scientific Verification Engine</div>
    <div class="report-meta">
        <span>Verification ID: <strong id="metaRunId"></strong></span><br>
        <span>Generated: <strong id="metaTimestamp"></strong></span><br>
        <span>Policy Profile: <strong id="metaPolicy"></strong></span>
    </div>

    <!-- Overall Assessment -->
    <div class="section-title">Overall Assessment</div>
    <p class="verdict-text" id="verdictText"></p>

    <!-- Risk Assessment -->
    <div class="section-title">Risk Assessment</div>
    <p class="risk-line">
        Risk Score: <span class="risk-value" id="riskScore"></span>
        (<span class="risk-label" id="severityLabel"></span>)
    </p>
    <p class="risk-interpretation" id="riskInterpretation" style="font-size:0.92rem; color:#444; margin-top:0.3rem;"></p>
    <div id="riskDriversSection" class="risk-drivers" style="display:none;"></div>

    <!-- Findings -->
    <div class="section-title">Findings</div>

    <div class="finding-category">Validated Claims</div>
    <ul class="finding-list" id="confirmedList"></ul>
    <p class="finding-none" id="noConfirmed" style="display:none;">No claims confirmed.</p>

    <div class="finding-category">Claims Requiring Additional Evidence</div>
    <ul class="finding-list" id="notVerifiableList"></ul>
    <p class="finding-none" id="noNotVerifiable" style="display:none;">All claims had sufficient cross-reference data.</p>

    <!-- Interpretation -->
    <div class="section-title" id="attentionTitle" style="display:none;">Interpretation</div>
    <div class="attention-block" id="attentionBlock" style="display:none;">
        <ul class="finding-list" id="attentionList" style="margin-bottom:0;"></ul>
    </div>

    <!-- Procedure Map -->
    <div id="procedureMapSection" style="display:none;">
        <div class="section-title">Procedure Map</div>
        <div id="clusterSummary" class="cluster-summary" style="display:none;"></div>
        <div id="topIssues"></div>
        <div id="procedureMap" class="procedure-map"></div>
    </div>

    <!-- Extracted Claims -->
    <div class="section-title">Extracted Claims (<span id="claimCount">0</span>)</div>
    <table class="claims-table">
        <thead>
            <tr>
                <th>Type</th>
                <th>Reported Value</th>
                <th>Normalized Value</th>
                <th>Unit</th>
                <th>Context</th>
                <th>Text Location</th>
            </tr>
        </thead>
        <tbody id="claimsTable"></tbody>
    </table>

    <!-- Points Requiring Author Clarification -->
    <div class="section-title" id="questionsTitle" style="display:none;">Points Requiring Author Clarification</div>
    <ol class="questions-list" id="questionsList"></ol>

    <!-- Verification Record -->
    <div class="section-title">Verification Record</div>
    <p style="font-size:0.85rem; color:#555; margin-bottom:0.8rem;">This report is reproducible from the analyzed text and policy profile. Re-running the verification under the same policy profile will produce identical findings.</p>
    <div class="provenance-grid">
        <div>
            <div class="prov-label">Verification ID</div>
            <div class="prov-value" id="provRunId"></div>
        </div>
        <div>
            <div class="prov-label">Status</div>
            <div class="prov-value" id="provStatus"></div>
        </div>
        <div>
            <div class="prov-label">Model</div>
            <div class="prov-value" id="provModel"></div>
        </div>
        <div>
            <div class="prov-label">Connector</div>
            <div class="prov-value" id="provConnector"></div>
        </div>
        <div>
            <div class="prov-label">Artifact Hash</div>
            <div class="prov-value" id="provArtifactHash"></div>
        </div>
        <div>
            <div class="prov-label">Chain Hash</div>
            <div class="prov-value" id="provChainHash"></div>
        </div>
    </div>

    <!-- Source Passage -->
    <div class="section-title">Source Passage</div>
    <p style="font-size:0.82rem; font-style:italic; color:#888; margin-bottom:0.4rem;">Analyzed verbatim input</p>
    <div class="analyzed-text" id="analyzedText"></div>

    <div class="report-footer">
        ChemVerify v0 — AI Governance Gateway · On-Premises Deployment · This report was generated automatically.
    </div>

</div>

<script>
    (async function () {
        const params = new URLSearchParams(window.location.search);
        const runId = params.get('id');

        if (!runId) {
            showError('No run ID specified. Use ?id={runId} in the URL.');
            return;
        }

        try {
            const res = await fetch(`/runs/${runId}/report`);
            if (!res.ok) {
                throw new Error(res.status === 404 ? 'Run not found.' : `HTTP ${res.status}`);
            }
            const data = await res.json();
            renderReport(data);
        } catch (err) {
            showError(err.message);
        }
    })();

    function showError(msg) {
        document.getElementById('loadingState').style.display = 'none';
        const el = document.getElementById('errorState');
        el.textContent = msg;
        el.style.display = 'block';
    }

    function renderReport(data) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('reportContent').style.display = 'block';

        const report = data.report;
        const run = data.artifact.run;

        // Meta (archival header — no debug info)
        document.getElementById('metaRunId').textContent = data.runId;
        document.getElementById('metaTimestamp').textContent = new Date(data.artifact.generatedUtc).toLocaleString();
        document.getElementById('metaPolicy').textContent = run.policyProfile || '—';

        // Overall Assessment
        document.getElementById('verdictText').textContent = report.verdict;

        // Risk Assessment with interpretive sentence
        document.getElementById('riskScore').textContent = data.riskScore.toFixed(4);
        const label = document.getElementById('severityLabel');
        label.textContent = report.severity;
        label.classList.add(`risk-label-${report.severity}`);
        document.getElementById('riskInterpretation').textContent = report.summary;

        // Risk Drivers
        if (report.riskDrivers && report.riskDrivers.length > 0) {
            const rd = document.getElementById('riskDriversSection');
            rd.style.display = '';
            const heading = document.createElement('div');
            heading.style.fontWeight = '600';
            heading.style.fontSize = '0.82rem';
            heading.style.textTransform = 'uppercase';
            heading.style.letterSpacing = '0.5px';
            heading.style.color = '#555';
            heading.style.marginBottom = '0.3rem';
            heading.textContent = 'Risk Drivers';
            rd.appendChild(heading);
            report.riskDrivers.forEach(d => {
                const row = document.createElement('div');
                row.className = 'risk-driver';
                const delta = document.createElement('span');
                delta.className = 'risk-driver-delta';
                if (d.delta > 0) { delta.classList.add('positive'); delta.textContent = `+${d.delta.toFixed(2)}`; }
                else if (d.delta < 0) { delta.classList.add('negative'); delta.textContent = d.delta.toFixed(2); }
                else { delta.classList.add('neutral'); delta.textContent = '  0.00'; }
                row.appendChild(delta);
                const lbl = document.createElement('span');
                lbl.className = 'risk-driver-label';
                lbl.textContent = d.label;
                row.appendChild(lbl);
                rd.appendChild(row);
            });
        }

        // Validated Claims
        renderList('confirmedList', 'noConfirmed', report.confirmed);

        // Claims Requiring Additional Evidence
        renderList('notVerifiableList', 'noNotVerifiable', report.notVerifiable);

        // Interpretation
        if (report.attention.length > 0) {
            document.getElementById('attentionTitle').style.display = '';
            document.getElementById('attentionBlock').style.display = '';
            const al = document.getElementById('attentionList');
            const findings = data.artifact.findings || [];
            let fIdx = 0;
            report.attention.forEach(a => {
                const li = document.createElement('li');
                li.textContent = a;
                // Link finding-level attention items to evidence anchors
                if (!a.startsWith('   ') && fIdx < findings.length) {
                    const f = findings[fIdx];
                    if (f.evidenceStartOffset != null) {
                        const anchor = document.createElement('a');
                        anchor.href = `#ev-${f.id}`;
                        anchor.textContent = ' ↓';
                        anchor.style.fontSize = '0.8rem';
                        anchor.style.color = '#b45309';
                        li.appendChild(anchor);
                    }
                    fIdx++;
                }
                al.appendChild(li);
            });
        }

        // Claims (sorted by context for analytical presentation)
        const contextOrder = { temp: 0, time: 1, conc: 2, yield: 3 };
        const claims = (data.artifact.claims || []).slice().sort((a, b) => {
            const ctxA = getCtx(a);
            const ctxB = getCtx(b);
            const oA = contextOrder[ctxA] ?? (a.claimType === 'CitationDoi' ? 99 : 50);
            const oB = contextOrder[ctxB] ?? (b.claimType === 'CitationDoi' ? 99 : 50);
            return oA - oB;
        });

        // Procedure Map
        const ps = data.procedureSummary;
        if (ps && ps.steps && ps.steps.length > 0) {
            document.getElementById('procedureMapSection').style.display = '';

            // Render cluster summary
            if (ps.clusters && ps.clusters.length > 0) {
                const cs = document.getElementById('clusterSummary');
                cs.style.display = '';
                const header = document.createElement('div');
                header.style.fontWeight = '700';
                header.style.marginBottom = '0.4rem';
                header.textContent = `Detected ${ps.clusters.length} condition cluster${ps.clusters.length > 1 ? 's' : ''}`;
                cs.appendChild(header);

                ps.clusters.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'cluster-item';
                    const sigParts = Object.values(c.signature || {});
                    const stepsLabel = c.stepIndexes.length === 1
                        ? `Step ${c.stepIndexes[0]}`
                        : `Steps ${c.stepIndexes.join(', ')}`;
                    div.innerHTML = `<span class="cluster-label">${esc(c.label)}:</span> ${sigParts.map(s => '<strong>' + esc(s) + '</strong>').join(', ')} (${esc(stepsLabel)})`;
                    cs.appendChild(div);
                });
            }

            // Render top issues
            if (ps.topIssues && ps.topIssues.length > 0) {
                const ti = document.getElementById('topIssues');
                ps.topIssues.forEach(issue => {
                    const card = document.createElement('div');
                    card.className = 'issue-card';
                    let html = `<div class="issue-title">${esc(issue.severity)} \u2014 ${esc(issue.title)}</div>`;
                    html += `<div class="issue-confidence">Confidence: ${issue.confidence.toFixed(2)}</div>`;
                    if (issue.why && issue.why.length > 0) {
                        html += '<ul class="issue-why">';
                        issue.why.forEach(w => { html += `<li>${esc(w)}</li>`; });
                        html += '</ul>';
                    }
                    card.innerHTML = html;
                    ti.appendChild(card);
                });
            }

            // Render step rows
            const map = document.getElementById('procedureMap');
            ps.steps.forEach(step => {
                const row = document.createElement('div');
                row.className = 'step-row';

                const idx = document.createElement('div');
                idx.className = 'step-index';
                idx.textContent = `Step ${step.stepIndex}`;
                row.appendChild(idx);

                const body = document.createElement('div');
                body.className = 'step-body';

                const snippet = document.createElement('div');
                snippet.className = 'step-snippet';
                snippet.textContent = step.stepSnippet;
                body.appendChild(snippet);

                if (step.claims && step.claims.length > 0) {
                    const badges = document.createElement('div');
                    badges.className = 'step-badges';
                    step.claims.forEach(c => {
                        const badge = document.createElement('span');
                        const ctx = (c.contextKey || '').toLowerCase();
                        badge.className = `claim-badge claim-badge-${ctx}`;
                        badge.textContent = c.rawText;
                        badges.appendChild(badge);
                    });
                    body.appendChild(badges);
                }

                row.appendChild(body);
                map.appendChild(row);
            });
        }

        document.getElementById('claimCount').textContent = claims.length;
        const tbody = document.getElementById('claimsTable');
        claims.forEach(c => {
            let ctx = '';
            if (c.jsonPayload) {
                try { ctx = JSON.parse(c.jsonPayload).contextKey || ''; } catch {}
            }
            const typeLabel = c.claimType === 'CitationDoi' ? 'DOI' : 'Numeric';
            const normalizedDisplay = c.claimType === 'CitationDoi' && c.normalizedValue
                ? `<a href="https://doi.org/${esc(c.normalizedValue)}" target="_blank" rel="noopener">${esc(c.normalizedValue)}</a>`
                : esc(c.normalizedValue || '—');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${esc(typeLabel)}</td>
                <td><code>${esc(c.rawText)}</code></td>
                <td>${normalizedDisplay}</td>
                <td>${esc(c.unit || '—')}</td>
                <td>${esc(ctx || '—')}</td>
                <td><code>${esc(c.sourceLocator || '—')}</code></td>`;
            tbody.appendChild(tr);
        });

        // Questions
        if (report.nextQuestions.length > 0) {
            document.getElementById('questionsTitle').style.display = '';
            const ql = document.getElementById('questionsList');
            report.nextQuestions.forEach(q => {
                const li = document.createElement('li');
                li.textContent = q;
                ql.appendChild(li);
            });
        }

        // Verification Record
        document.getElementById('provRunId').textContent = data.runId;
        document.getElementById('provStatus').textContent = run.status;
        document.getElementById('provModel').textContent = run.modelName || '—';
        document.getElementById('provConnector').textContent = run.connectorName || '—';
        document.getElementById('provArtifactHash').textContent = data.artifact.artifactHash;
        document.getElementById('provChainHash').textContent = run.currentHash;

        // Analyzed text with evidence highlighting
        const analyzedText = run.output && run.output.length > 0
            ? run.output
            : (run.inputText && run.inputText.length > 0 ? run.inputText : '');
        const findings = data.artifact.findings || [];
        renderHighlightedText('analyzedText', analyzedText, findings);

        // Update page title
        document.title = `Verification Report — ${data.runId}`;
    }

    function renderHighlightedText(elementId, text, findings) {
        const el = document.getElementById(elementId);
        if (!text) { el.textContent = ''; return; }

        // Collect spans that have offsets, sort by start descending to insert from end
        const spans = findings
            .filter(f => f.evidenceStartOffset != null && f.evidenceEndOffset != null
                      && f.evidenceStartOffset >= 0 && f.evidenceEndOffset <= text.length)
            .map(f => ({ id: f.id, start: f.evidenceStartOffset, end: f.evidenceEndOffset }))
            .sort((a, b) => a.start - b.start);

        if (spans.length === 0) {
            el.textContent = text;
            return;
        }

        // Merge overlapping spans
        const merged = [spans[0]];
        for (let i = 1; i < spans.length; i++) {
            const prev = merged[merged.length - 1];
            if (spans[i].start <= prev.end) {
                prev.end = Math.max(prev.end, spans[i].end);
                prev.id = prev.id || spans[i].id;
            } else {
                merged.push({ ...spans[i] });
            }
        }

        // Build HTML with highlights
        el.innerHTML = '';
        let cursor = 0;
        merged.forEach(s => {
            if (s.start > cursor) {
                el.appendChild(document.createTextNode(text.slice(cursor, s.start)));
            }
            const mark = document.createElement('mark');
            mark.className = 'evidence-highlight';
            mark.id = `ev-${s.id}`;
            mark.textContent = text.slice(s.start, s.end);
            el.appendChild(mark);
            cursor = s.end;
        });
        if (cursor < text.length) {
            el.appendChild(document.createTextNode(text.slice(cursor)));
        }
    }

    function renderList(listId, noneId, items) {
        const ul = document.getElementById(listId);
        if (items.length === 0) {
            ul.style.display = 'none';
            document.getElementById(noneId).style.display = '';
        } else {
            items.forEach(text => {
                const li = document.createElement('li');
                li.textContent = text;
                ul.appendChild(li);
            });
        }
    }

    function getCtx(c) {
        if (!c.jsonPayload) return '';
        try { return JSON.parse(c.jsonPayload).contextKey || ''; } catch { return ''; }
    }

    function esc(str) {
        const d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
    }
</script>

</body>
</html>

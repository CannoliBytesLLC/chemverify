<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ChemVerify ‚Äî AI Governance Gateway</title>
    <link rel="stylesheet" href="/lib/bootstrap/dist/css/bootstrap.min.css" />
    <style>
        :root {
            --cv-accent: #3b82f6;
            --cv-pass: #22c55e;
            --cv-warn: #f59e0b;
            --cv-fail: #ef4444;
            --cv-info: #6366f1;
        }
        body { background: #0f1117; color: #e2e8f0; font-family: 'Segoe UI', system-ui, sans-serif; }
        .cv-header { border-bottom: 1px solid #1e293b; padding: 1.5rem 0; }
        .cv-header h1 { font-weight: 700; letter-spacing: -0.5px; }
        .cv-header .badge { font-size: 0.65rem; vertical-align: middle; }
        .severity-badge { font-size: 1rem; padding: 0.35em 0.75em; border-radius: 6px; font-weight: 600; }
        .severity-Low { background: rgba(34,197,94,0.15); color: var(--cv-pass); border: 1px solid rgba(34,197,94,0.3); }
        .severity-Medium { background: rgba(245,158,11,0.15); color: var(--cv-warn); border: 1px solid rgba(245,158,11,0.3); }
        .severity-High { background: rgba(239,68,68,0.15); color: var(--cv-fail); border: 1px solid rgba(239,68,68,0.3); }
        .severity-Critical { background: rgba(239,68,68,0.25); color: #fca5a5; border: 1px solid rgba(239,68,68,0.5); }
        .risk-score { font-size: 2.5rem; font-weight: 800; font-variant-numeric: tabular-nums; }
        .card-section { background: #1a1d27; border: 1px solid #2d3348; border-radius: 10px; }
        .check-item { padding: 0.6rem 0; border-bottom: 1px solid #2d3348; }
        .check-item:last-child { border-bottom: none; }
        .check-icon { width: 1.5rem; text-align: center; flex-shrink: 0; }
        .meta-label { color: #94a3b8; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .meta-value { font-family: 'Cascadia Code', 'Fira Code', monospace; font-size: 0.85rem; color: #cbd5e1; }
        .json-toggle { cursor: pointer; color: var(--cv-accent); font-size: 0.85rem; }
        .json-toggle:hover { text-decoration: underline; }
        .json-block { background: #12141c; border: 1px solid #2d3348; border-radius: 8px; font-size: 0.78rem;
                       max-height: 500px; overflow-y: auto; display: none; }
        .spinner-border { width: 1.2rem; height: 1.2rem; }
        .prompt-display { background: #12141c; border: 1px solid #2d3348; border-radius: 8px; padding: 1rem;
                          font-family: 'Cascadia Code', 'Fira Code', monospace; font-size: 0.85rem; color: #94a3b8; }
        .claim-badge { font-size: 0.7rem; padding: 0.2em 0.5em; border-radius: 4px; }
        .claim-badge-doi { background: rgba(99,102,241,0.15); color: var(--cv-info); }
        .claim-badge-numeric { background: rgba(59,130,246,0.15); color: var(--cv-accent); }
        #reportSection { display: none; }
    </style>
</head>
<body>

<!-- Header -->
<div class="cv-header">
    <div class="container">
        <div class="d-flex align-items-center gap-3">
            <h1 class="mb-0 fs-4">üõ°Ô∏è ChemVerify</h1>
            <span class="badge bg-secondary">v0 ‚Äî AI Governance Gateway</span>
        </div>
        <p class="text-secondary mb-0 mt-1" style="font-size:0.85rem;">
            On-prem verification pipeline for AI-generated scientific content
        </p>
    </div>
</div>

<div class="container py-4">

    <!-- Run Controls -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card-section p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Input</h5>
                    <span class="badge bg-primary">StrictChemistryV0</span>
                </div>
                <div class="prompt-display mb-3" id="promptDisplay">
                    Describe the Suzuki-Miyaura coupling reaction conditions including temperature, time, solvent, yield, and cite relevant literature with DOIs.
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <button class="btn btn-primary px-4" id="runBtn" onclick="runVerification()">
                        Run Verification
                    </button>
                    <a class="btn btn-outline-secondary btn-sm" id="reportLink" href="#" target="_blank" style="display:none;">
                        View Formal Report ‚Üó
                    </a>
                    <span class="text-secondary" style="font-size:0.8rem;" id="statusText">Ready</span>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card-section p-3 h-100">
                <div class="meta-label mb-2">Configuration</div>
                <div class="d-flex flex-column gap-2">
                    <div><span class="text-secondary">Policy:</span> <span class="meta-value">StrictChemistryV0</span></div>
                    <div><span class="text-secondary">Model:</span> <span class="meta-value">mock</span></div>
                    <div><span class="text-secondary">Contract:</span> <span class="meta-value">FreeText</span></div>
                    <div><span class="text-secondary">User:</span> <span class="meta-value">demo-user</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Section (shown after run) -->
    <div id="reportSection">

        <!-- Verification Summary -->
        <div class="card-section p-4 mb-4">
            <h6 class="mb-3" style="color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; font-size:0.75rem;">Verification Summary</h6>
            <div class="row align-items-center mb-3">
                <div class="col">
                    <div class="meta-label mb-1">Verdict</div>
                    <p class="mb-0" id="verdictText" style="font-size:1.05rem; font-weight:500;"></p>
                </div>
            </div>
            <div class="row align-items-center mb-3">
                <div class="col-auto">
                    <div class="meta-label mb-1">Risk Score</div>
                    <div class="risk-score" id="riskScore">‚Äî</div>
                </div>
                <div class="col-auto">
                    <span class="severity-badge" id="severityBadge">‚Äî</span>
                </div>
                <div class="col">
                    <p class="mb-0 text-secondary" id="summaryText" style="font-size:0.85rem;"></p>
                </div>
            </div>
            <div style="font-size:0.75rem; color:#64748b; line-height:1.7;">
                <strong>Low</strong> (0.00‚Äì0.10): No contradictions detected &nbsp;¬∑&nbsp;
                <strong>Medium</strong> (0.11‚Äì0.35): Missing or ambiguous constraints &nbsp;¬∑&nbsp;
                <strong>High</strong> (0.36‚Äì0.65): Inconsistency detected &nbsp;¬∑&nbsp;
                <strong>Critical</strong> (0.66+): Significant contradictions present
            </div>
        </div>

        <div class="row g-4 mb-4">

            <!-- Verification Findings -->
            <div class="col-lg-6">
                <div class="card-section p-3 h-100">
                    <h6 class="mb-3">Verification Findings</h6>

                    <div class="meta-label mb-2" style="font-size:0.7rem;">Confirmed</div>
                    <div id="confirmedList"></div>
                    <div id="noConfirmed" class="text-secondary mb-3" style="font-size:0.82rem; display:none;">
                        No claims confirmed.
                    </div>

                    <div class="meta-label mb-2 mt-3" style="font-size:0.7rem;">Insufficient Cross-Reference Data</div>
                    <div id="notVerifiableList"></div>
                    <div id="noNotVerifiable" class="text-secondary" style="font-size:0.82rem; display:none;">
                        All claims had sufficient cross-reference data.
                    </div>

                    <div class="text-secondary mt-3" style="font-size:0.75rem;" id="checksMeta"></div>
                </div>
            </div>

            <!-- Attention -->
            <div class="col-lg-6">
                <div class="card-section p-3 h-100" style="border-color:rgba(245,158,11,0.3); background:#1a1a22;">
                    <h6 class="mb-3" style="color:var(--cv-warn);">‚ö†Ô∏è Attention</h6>
                    <div id="attentionList"></div>
                    <div id="noAttention" class="text-secondary" style="font-size:0.85rem; display:none;">
                        No issues requiring attention.
                    </div>
                </div>
            </div>

        </div>

        <!-- Extracted Claims -->
        <div class="card-section p-3 mb-4">
            <h6 class="mb-3">üìã Extracted Claims (<span id="claimCount">0</span>)</h6>
            <div class="table-responsive">
                <table class="table table-sm table-dark mb-0" style="font-size:0.85rem;">
                    <thead>
                        <tr class="text-secondary">
                            <th>Type</th>
                            <th>Raw Text</th>
                            <th>Normalized</th>
                            <th>Unit</th>
                            <th>Context</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody id="claimsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Next Questions -->
        <div class="card-section p-3 mb-4" id="questionsSection" style="display:none;">
            <h6 class="mb-3">‚ùì Suggested Next Questions</h6>
            <ul class="mb-0" id="questionsList" style="font-size:0.9rem;"></ul>
        </div>

        <!-- Verification Record -->
        <div class="card-section p-3 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">üîó Verification Provenance</h6>
                <span class="json-toggle" onclick="toggleJson()">Show raw JSON ‚ñæ</span>
            </div>
            <div class="row g-3" style="font-size:0.85rem;">
                <div class="col-md-4">
                    <div class="meta-label">Run ID</div>
                    <div class="meta-value" id="metaRunId">‚Äî</div>
                </div>
                <div class="col-md-4">
                    <div class="meta-label">Connector</div>
                    <div class="meta-value" id="metaConnector">‚Äî</div>
                </div>
                <div class="col-md-4">
                    <div class="meta-label">Status</div>
                    <div class="meta-value" id="metaStatus">‚Äî</div>
                </div>
                <div class="col-md-4">
                    <div class="meta-label">Artifact Hash</div>
                    <div class="meta-value text-truncate" id="metaHash" style="max-width:300px;">‚Äî</div>
                </div>
                <div class="col-md-4">
                    <div class="meta-label">Chain Hash</div>
                    <div class="meta-value text-truncate" id="metaChainHash" style="max-width:300px;">‚Äî</div>
                </div>
                <div class="col-md-4">
                    <div class="meta-label">Generated</div>
                    <div class="meta-value" id="metaTimestamp">‚Äî</div>
                </div>
            </div>
            <div class="json-block mt-3 p-3" id="jsonBlock">
                <pre class="mb-0 text-light" id="jsonContent" style="white-space:pre-wrap; word-break:break-all;"></pre>
            </div>
        </div>

        <!-- Analyzed Text (collapsible, last) -->
        <div class="card-section p-3 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">üìÑ Analyzed Text</h6>
                <span class="json-toggle" onclick="toggleOutput()">Show source text ‚ñæ</span>
            </div>
            <div class="prompt-display mt-3" id="modelOutput" style="color:#e2e8f0; display:none;"></div>
        </div>

    </div>
</div>

<footer class="text-center text-secondary py-4" style="font-size:0.75rem; border-top:1px solid #1e293b;">
    ChemVerify v0 ‚Äî AI Governance Gateway &middot; On-Premises Deployment
</footer>

<script>
    async function runVerification() {
        const btn = document.getElementById('runBtn');
        const status = document.getElementById('statusText');

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border" role="status"></span> Running‚Ä¶';
        status.textContent = 'Submitting to pipeline‚Ä¶';

        const request = {
            prompt: document.getElementById('promptDisplay').textContent.trim(),
            userId: "demo-user",
            modelName: "mock",
            policyProfile: "StrictChemistryV0",
            outputContract: "FreeText"
        };

        try {
            const res = await fetch('/runs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(request)
            });

            if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${await res.text()}`);
            }

            const data = await res.json();
            renderReport(data);
            status.textContent = 'Verification complete';
        } catch (err) {
            status.textContent = `Error: ${err.message}`;
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Run Verification';
        }
    }

    function renderReport(data) {
        document.getElementById('reportSection').style.display = 'block';

        // Show formal report link
        const reportLink = document.getElementById('reportLink');
        reportLink.href = `/report.html?id=${data.runId}`;
        reportLink.style.display = '';

        // Risk score
        const score = data.riskScore;
        document.getElementById('riskScore').textContent = score.toFixed(4);

        // Severity badge
        const report = data.report;
        const badge = document.getElementById('severityBadge');
        badge.textContent = report.severity;
        badge.className = `severity-badge severity-${report.severity}`;

        // Verdict + Summary
        document.getElementById('verdictText').textContent = report.verdict;
        document.getElementById('summaryText').textContent = report.summary;

        // Confirmed findings
        const cl = document.getElementById('confirmedList');
        cl.innerHTML = '';
        if (report.confirmed.length === 0) {
            document.getElementById('noConfirmed').style.display = 'block';
        } else {
            document.getElementById('noConfirmed').style.display = 'none';
            report.confirmed.forEach(h => {
                cl.innerHTML += `<div class="check-item d-flex align-items-start gap-2">
                    <span class="check-icon">‚úÖ</span>
                    <span>${escHtml(h)}</span>
                </div>`;
            });
        }

        // Not Verifiable
        const nv = document.getElementById('notVerifiableList');
        nv.innerHTML = '';
        if (report.notVerifiable.length === 0) {
            document.getElementById('noNotVerifiable').style.display = 'block';
        } else {
            document.getElementById('noNotVerifiable').style.display = 'none';
            report.notVerifiable.forEach(h => {
                nv.innerHTML += `<div class="check-item d-flex align-items-start gap-2">
                    <span class="check-icon">‚ÑπÔ∏è</span>
                    <span style="color:#94a3b8;">${escHtml(h)}</span>
                </div>`;
            });
        }

        // Attention
        const al = document.getElementById('attentionList');
        al.innerHTML = '';
        if (report.attention.length === 0) {
            document.getElementById('noAttention').style.display = 'block';
        } else {
            document.getElementById('noAttention').style.display = 'none';
            report.attention.forEach(a => {
                al.innerHTML += `<div class="check-item d-flex align-items-start gap-2">
                    <span>${escHtml(a)}</span>
                </div>`;
            });
        }

        // Claims table
        const claims = data.artifact.claims || [];
        document.getElementById('claimCount').textContent = claims.length;
        const tbody = document.getElementById('claimsTable');
        tbody.innerHTML = '';
        claims.forEach(c => {
            const typeBadge = c.claimType === 'CitationDoi'
                ? '<span class="claim-badge claim-badge-doi">DOI</span>'
                : '<span class="claim-badge claim-badge-numeric">Numeric</span>';

            let ctx = '';
            if (c.jsonPayload) {
                try {
                    const p = JSON.parse(c.jsonPayload);
                    ctx = p.contextKey || '';
                } catch { }
            }

            tbody.innerHTML += `<tr>
                <td>${typeBadge}</td>
                <td><code>${escHtml(c.rawText)}</code></td>
                <td>${escHtml(c.normalizedValue || '‚Äî')}</td>
                <td>${escHtml(c.unit || '‚Äî')}</td>
                <td>${escHtml(ctx || '‚Äî')}</td>
                <td><code style="font-size:0.75rem;">${escHtml(c.sourceLocator || '‚Äî')}</code></td>
            </tr>`;
        });

        // Checks meta
        const findings = data.artifact.findings || [];
        const pass = findings.filter(f => f.status === 'Pass').length;
        const fail = findings.filter(f => f.status === 'Fail').length;
        const unv = findings.filter(f => f.status === 'Unverified').length;
        document.getElementById('checksMeta').textContent =
            `${findings.length} checks: ${pass} passed, ${fail} failed, ${unv} unverified`;

        // Next questions
        const qs = document.getElementById('questionsList');
        const qsSection = document.getElementById('questionsSection');
        qs.innerHTML = '';
        if (report.nextQuestions.length > 0) {
            qsSection.style.display = 'block';
            report.nextQuestions.forEach(q => {
                qs.innerHTML += `<li class="mb-1">${escHtml(q)}</li>`;
            });
        } else {
            qsSection.style.display = 'none';
        }

        // Verification Record
        const run = data.artifact.run;
        document.getElementById('metaRunId').textContent = data.runId;
        document.getElementById('metaConnector').textContent = run.connectorName || '‚Äî';
        document.getElementById('metaStatus').textContent = run.status;
        document.getElementById('metaHash').textContent = data.artifact.artifactHash;
        document.getElementById('metaChainHash').textContent = run.currentHash;
        document.getElementById('metaTimestamp').textContent = new Date(data.artifact.generatedUtc).toLocaleString();

        // Analyzed text (hidden by default)
        document.getElementById('modelOutput').textContent = run.output;

        // Raw JSON
        document.getElementById('jsonContent').textContent = JSON.stringify(data, null, 2);
    }

    function toggleJson() {
        const block = document.getElementById('jsonBlock');
        block.style.display = block.style.display === 'none' ? 'block' : 'none';
    }

    function toggleOutput() {
        const block = document.getElementById('modelOutput');
        block.style.display = block.style.display === 'none' ? 'block' : 'none';
    }

    function escHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }
</script>

</body>
</html>
